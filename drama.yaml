nodes:
- parameters: {}
  name: Start
  type: n8n-nodes-base.start
  typeVersion: 1
  position:
  - -1184
  - -224
  id: b6427238-8bb3-4d07-9477-dc4694fcee6d
- parameters:
    triggerTimes:
      item:
      - hour: 0
        minute: 5
  name: Cron
  type: n8n-nodes-base.cron
  typeVersion: 1
  position:
  - -1184
  - -32
  id: 091c2cde-14f2-4912-bf1e-512221c4fc0e
- parameters:
    url: https://raw.githubusercontent.com/FunnyGuilds/FunnyDrama/master/data/elements.json
    options: {}
  name: Fetch elements.json
  type: n8n-nodes-base.httpRequest
  typeVersion: 1
  position:
  - -512
  - -128
  id: 1c3d604c-dcc1-46ec-ad52-4164060a18a2
- parameters:
    url: https://raw.githubusercontent.com/FunnyGuilds/FunnyDrama/master/data/sentences.json
    options: {}
  name: Fetch sentences.json
  type: n8n-nodes-base.httpRequest
  typeVersion: 1
  position:
  - -288
  - -128
  id: 6ec650d0-5450-4c63-9ef4-90ba4bb00ff6
- parameters:
    jsCode: |-
      // noinspection PointlessBitwiseExpressionJS

      const sentences = $("Fetch sentences.json").first().json;
      const elements = $("Fetch elements.json").first().json;
      const fieldPattern = /\[(?<name>[a-zA-Z0-9_]+)\]/;

      const alreadyUsed = [];

      const createDrama = () => {

        let sentence = sentences[Math.random() * sentences.length | 0];
        let matcher;
        
        while ((matcher = fieldPattern.exec(sentence)) !== null) {
        
            const fieldFull = matcher[0];
            const fieldType = matcher[1];
        
            if (!(fieldType in elements)) {
                return {sentence: `Unknown element type: ${fieldType}`}
            }
        
            let randomValue;
            do {
                randomValue = elements[fieldType][Math.random() * elements[fieldType].length | 0];
            }
            while (randomValue in alreadyUsed);
        
            alreadyUsed.push(randomValue);
            sentence = sentence.replace(fieldFull, randomValue);
        }

        return sentence;
      }

      return {
        json: {
          dramas: Array.from({ length: 10 }, createDrama)
        }
      };
  type: n8n-nodes-base.code
  typeVersion: 2
  position:
  - -64
  - -128
  id: 00ea2b2f-ca4c-4575-9fd4-780c9b7a0dd2
  name: Generate Drama
  executeOnce: false
- parameters:
    assignments:
      assignments:
      - id: f9d5d320-3a19-4607-a764-10f32f5e28ce
        name: config
        value: ={{ $('Channel Config').item.json }}
        type: object
      - id: 88a8a7a9-3bb8-4adc-b0b6-79c7552db592
        name: content
        value: ={{ $json.output[1].content[0].text }}
        type: string
      - id: 090620a9-bb2f-4ac2-9f3d-a8d5749449fb
        name: cost
        value: ={{ $json.usage.cost }}
        type: number
      - id: f22b148a-93fa-436c-851d-38a7c11368b1
        name: tokens
        value: |-
          ={
          input: {{ $json.usage.input_tokens }},
          cached: {{ $json.usage.input_tokens_details.cached_tokens }},
          output: {{ $json.usage.output_tokens }},
          reasoning: {{ $json.usage.output_tokens_details.reasoning_tokens }}
          }
        type: object
      - id: f2adc1c9-b552-48d3-95f3-636db2370046
        name: reasoning_url
        value: ={{ $json.reasoning_url }}
        type: string
    options: {}
  type: n8n-nodes-base.set
  typeVersion: 3.4
  position:
  - 1008
  - -128
  id: b2abfeed-9162-4d7a-bc44-f0b1794cf071
  name: Extract AI Drama
- parameters:
    mode: runOnceForEachItem
    jsCode: |-
      return {json: {
        dramaStyle: $json[Math.floor(Math.random() * $json.length)]
      }};
  type: n8n-nodes-base.code
  typeVersion: 2
  position:
  - -64
  - 80
  id: a505c2cf-a0ef-4115-a351-50c629568861
  name: Generate Style
  alwaysOutputData: true
  executeOnce: true
- parameters: {}
  type: n8n-nodes-base.noOp
  typeVersion: 1
  position:
  - -960
  - -128
  id: bf2396b0-c290-41d7-b3fb-d83bb4a2e78f
  name: No Operation, do nothing
- parameters:
    url: https://raw.githubusercontent.com/FunnyGuilds/FunnyDrama/master/data/styles.json
    options: {}
  name: Fetch styles.json
  type: n8n-nodes-base.httpRequest
  typeVersion: 1
  position:
  - -288
  - 80
  id: 5a39eaa7-f292-496d-94e9-132d3024b100
- parameters:
    content: |-
      # By SandrÃ¦ :3
      Made with ignorance and prayers.
    height: 96
    width: 256
  type: n8n-nodes-base.stickyNote
  typeVersion: 1
  position:
  - 1280
  - 176
  id: be722860-b9cd-4f00-8b1d-5cd04728236e
  name: Sticky Note
- parameters:
    jsCode: |-
      return [
        {
          json: {
            server: '254623242914889729',
            channels: [
              {
                name: 'main',
                id: '826950650410958920'
              },
              {
                name: 'help',
                id: '278157499851341825'
              }
            ],
            out: '826950650410958920'
          },
        },
        {
          json: {
            server: '254623242914889729',
            channels: [
              {
                name: 'underground',
                id: '254623242914889729'
              }
            ],
            out: '254623242914889729'
          }
        }
      ];
  type: n8n-nodes-base.code
  typeVersion: 2
  position:
  - -736
  - -320
  id: 62da842a-0494-4924-a057-52d44c904cad
  name: Channel Config
- parameters:
    jsCode: |
      const filterContent = (text, maxLength = 1000) => {
          const cleaned = text.replace(/[\r\n]+/g, '<br>');
          return cleaned.length > maxLength
              ? cleaned.slice(0, maxLength - 3) + '...'
              : cleaned;
      };

      const getAgo = (time) => {
          const diff = new Date() - new Date(time);
          const hours = Math.floor(diff / (1000 * 60 * 60));
          const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
          return { hours, minutes };
      };

      const result = {};
      const config = $('Channel Config').all();
      const channelMap = {};
      const lastAgoTimestamp = {}; // Track last timestamp where we showed ago per channel
      for (const {json} of config) {
          for (const {name, id} of json.channels) {
              channelMap[id] = name;
              result[name] = [];
              lastAgoTimestamp[name] = null;
          }
      }

      for (const item of $input.all().reverse()) {

          const {  channel_id, timestamp, content } = item.json;
          const author = item.json.author.global_name || item.json.author.username;
          if (!author || !content) continue;

          const { hours, minutes } = getAgo(timestamp);
          if (hours >= 20) continue;

          const filtered = filterContent(content);
          const channelName = channelMap[channel_id] || "unknown";

          const channelMessages = result[channelName];
          const lastMessage = channelMessages[channelMessages.length - 1];

          // Check if we should merge with the last message
          if (lastMessage && lastMessage.author === author) {
              const timeDiff = new Date(timestamp) - new Date(lastMessage.timestamp);
              const minutesDiff = timeDiff / (1000 * 60);

              if (minutesDiff >= 0 && minutesDiff <= 5) {
                  // Merge with previous message
                  lastMessage.content += '\n' + filtered;
                  lastMessage.timestamp = timestamp; // Update to latest timestamp
                  continue;
              }
          }

          // Determine if we should show ago
          let showAgo = false;
          if (lastAgoTimestamp[channelName] === null) {
              showAgo = true; // First message in channel
          } else {
              const timeSinceLastAgo = (new Date(timestamp) - new Date(lastAgoTimestamp[channelName])) / (1000 * 60);
              showAgo = timeSinceLastAgo >= 15;
          }

          // Add as new message
          const newMessage = {
              author,
              content: filtered,
              timestamp
          };

          if (showAgo) {
              newMessage.ago = `${hours}h${minutes}m`;
              lastAgoTimestamp[channelName] = timestamp;
          }

          channelMessages.push(newMessage);
      }

      // Remove timestamp field from final output
      for (const channelName in result) {
          result[channelName] = result[channelName].map(msg => {
              const output = {
                  author: msg.author,
                  content: msg.content
              };
              if (msg.ago) {
                  output.ago = msg.ago;
              }
              return output;
          });
      }

      return [{
          json: {
              messages: result
          }
      }];
  type: n8n-nodes-base.code
  typeVersion: 2
  position:
  - -64
  - -320
  id: 4448ed9c-b939-4e77-861b-165e041fff0d
  name: Format Messages
  executeOnce: false
- parameters:
    url: =https://discord.com/api/v10/channels/{{ $json.channels.id }}/messages
    authentication: predefinedCredentialType
    nodeCredentialType: discordBotApi
    sendQuery: true
    queryParameters:
      parameters:
      - name: limit
        value: '100'
    options:
      pagination:
        pagination:
          paginationMode: responseContainsNextURL
          nextURL: "={{ $response.body.length >= 100 ? 'https://discord.com/api/v10/channels/' + $json.channels.id + '/messages?limit=100&before=' + $response.body[$response.body.length - 1].id : '' }}"
          limitPagesFetched: true
          maxRequests: 4
  type: n8n-nodes-base.httpRequest
  typeVersion: 4.2
  position:
  - -288
  - -320
  id: 617ff2b8-8c88-410c-8c42-60e1c896cca6
  name: Get Messages
  retryOnFail: false
  executeOnce: false
  credentials:
    discordBotApi:
      id: ng2YWjEby2jmXzo7
      name: Discord Bot account
- parameters:
    mode: combine
    combineBy: combineByPosition
    numberInputs: 3
    options:
      includeUnpaired: true
  type: n8n-nodes-base.merge
  typeVersion: 3.2
  position:
  - 176
  - -144
  id: d9523cf5-c7e2-4777-8faf-cc7f82b2ef7c
  name: Merge Shared
  executeOnce: true
- parameters:
    mode: combine
    combineBy: combineAll
    options: {}
  type: n8n-nodes-base.merge
  typeVersion: 3.2
  position:
  - 400
  - -128
  id: 803078fa-1e40-44ec-8210-00d267b72e04
  name: Seed Channels
  retryOnFail: false
  executeOnce: false
- parameters:
    fieldToSplitOut: channels
    include: allOtherFields
    options: {}
  type: n8n-nodes-base.splitOut
  typeVersion: 1
  position:
  - -512
  - -320
  id: c0d5e9e2-0950-435e-9654-1b62f7598f9e
  name: Split Out Channels
- parameters:
    resource: message
    guildId:
      __rl: true
      value: ={{ $json.config.server }}
      mode: id
    channelId:
      __rl: true
      value: ={{ $json.config.out }}
      mode: id
    options: {}
    embeds:
      values:
      - inputMethod: json
        json: |-
          ={
            "title": "Latest Drama News",
            "url": {{ $json.reasoning_url.toJsonString() }},
            "description": {{ $json.content.toJsonString() }},
            "footer": {
            "text": "${{ $json.cost || 0 }} ({{ $json.tokens.input }}t in, {{ $json.tokens.output - $json.tokens.reasoning }}/{{ $json.tokens.output }}t out)"
            },
            "allowed_mentions": { "parse": [] },
            "color": 16723502
          }
  type: n8n-nodes-base.discord
  typeVersion: 2
  position:
  - 1216
  - -128
  id: 81dea437-61ee-4d68-9dfb-697b19a7afe1
  name: Dispatch Drama
  webhookId: 017a8361-4c62-4d78-b4a3-1b5385701d29
  credentials:
    discordBotApi:
      id: ng2YWjEby2jmXzo7
      name: Discord Bot account
- parameters:
    resource: message
    operation: react
    guildId:
      __rl: true
      value: ={{ $('Channel Config').item.json.server }}
      mode: id
    channelId:
      __rl: true
      value: ={{ $json.channel_id }}
      mode: id
    messageId: ={{ $json.id }}
    emoji: ðŸ”¥
  type: n8n-nodes-base.discord
  typeVersion: 2
  position:
  - 1440
  - -240
  id: 3fbf5b60-4cd5-4196-a56c-ca9eca30b9b1
  name: React with ðŸ”¥
  webhookId: 62a2dd65-30a5-4e83-83e3-306ea81beb21
  credentials:
    discordBotApi:
      id: ng2YWjEby2jmXzo7
      name: Discord Bot account
  disabled: true
- parameters:
    resource: message
    operation: react
    guildId:
      __rl: true
      value: ={{ $('Channel Config').item.json.server }}
      mode: id
    channelId:
      __rl: true
      value: ={{ $json.channel_id }}
      mode: id
    messageId: ={{ $json.id }}
    emoji: ðŸ¥¶
  type: n8n-nodes-base.discord
  typeVersion: 2
  position:
  - 1440
  - -48
  id: 6f76586a-eeee-4399-bc65-adec46d00df1
  name: React with ðŸ¥¶
  webhookId: 62a2dd65-30a5-4e83-83e3-306ea81beb21
  credentials:
    discordBotApi:
      id: ng2YWjEby2jmXzo7
      name: Discord Bot account
  disabled: true
- parameters:
    method: POST
    url: https://openrouter.ai/api/v1/responses
    authentication: predefinedCredentialType
    nodeCredentialType: openRouterApi
    sendBody: true
    bodyParameters:
      parameters:
      - name: model
        value: anthropic/claude-opus-4.5
      - name: input
        value: |-
          =Generate a **short, punchy** fictional drama statement with a blunt, chaotic tone, prioritizing the chat history for inspiration.

          Current time: {{ new Intl.DateTimeFormat('en-CA', {
            timeZone: 'Europe/Warsaw',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
          }).format(new Date()).replace(',', '') }}

          #### **INPUT SOURCES (PRIORITY ORDER)**

          **Format:**
          Author1 (time ago): Message content
          Author2: Message content
          (time shown only every 15min)

          1. **CHAT HISTORY (PRIMARY SOURCE)**

          {{
          $json.channels
            .map(channel => [channel.name, $json.messages[channel.name]])
            .map(([channel, msgs]) => 
              `### #${channel} CHANNEL\n` +
              msgs
                .map(it => {
                  const agoStr = it.ago ? ` (${it.ago})` : '';
                  return `${it.author}${agoStr}: ${it.content}`;
                })
                .join('\n')
            )
            .join('\n\n')
          }}

          2. **FALLBACK EXAMPLES (ONLY IF CHAT IS BORING)**
          {{
          $json.dramas
            .map(drama => `- ${drama}`)
            .join('\n')
          }}

          #### **DRAMA SELECTION CRITERIA**
          - **Scan for:** Fights, dumb takes, panic, confusion, or general clusterfuck moments.
          - **Final output uses ONE drama element** (e.g., "config system is broken" â†’ ignore linked drama like "x is sleeping again").
          - **Never use first person or insert yourself**â€”comment on the drama, don't participate in it.

          #### **RULES (NON-NEGOTIABLE)**
          1. **AVOID REPETITION** - Refrain from referencing examples from the rules itself (such as PM, CI) as this causes repetition.
          2. **NO DULL DRAMA** - When chat is boring or lacking in general, prefer using FALLBACK EXAMPLES for the drama. When using one of the fallback examples, use the example almost verbatim only fixing minor stylistic issues.
          3. **ONE TOPIC ONLY** â€“ No "and", "also", or list-like drama.
             - **BAD:** Kamilkime hates DDD, CI is dead, and the PM ghosted us.
             - **GOOD:** Kamilkime just deleted the 'forge' module screaming 'YOLO'.
             - **EXCEPTION (style-dependent):**
               - If the style requires multiple elements that can't fit in one topic, you may combine topics
               - If the style has a specific format (like greentext with multiple ">be me" lines), follow that format instead
             - Keep it **concise** - don't waste words.
          4. **NO RECENCY BIAS** - Don't prioritize recent messagesâ€”the spiciest drama could be anywhere in the chat history.

          4. **CHAOS MULTIPLIER** â€“ Escalate the chosen topic with one or more of:
             - Sabotage
             - Public meltdowns
             - Absurd lies

          5. **STYLE:** {{ $json.dramaStyle }}

          #### **GENERATION WORKFLOW**

          Follow this multi-step process to ensure maximum quality:

          1. **IDENTIFY CANDIDATES**
             - Scan chat history and fallback examples for spicy moments
             - List the top 3 candidates (fights, dumb takes, panic, confusion, clusterfucks)
             - Each candidate should be ONE distinct drama element/topic
             - If fewer than 3 exist, reuse the best one with different chaos approaches

          2. **GENERATE 3 VERSIONS**
             - For each candidate, write one complete drama
             - Apply the style requirement ({{ $json.dramaStyle }})
             - Use different chaos multipliers: sabotage, public meltdowns, or absurd lies
             - Keep each version focused on ONE topic (no "and" or lists)

          3. **EVALUATE & SELECT**
             - Compare all 3 versions against the rules
             - Rate each on: spiciness, style accuracy, chaos level, rule compliance
             - Pick the winner that maximizes all criteria
             - Explain your choice briefly

          4. **REFINE**
             - Take the winning version and polish it
             - Ensure maximum impact while staying concise
             - Verify: no fancy formatting, ONE topic only
             - Final check against all rules

          #### **OUTPUT FORMAT**
          After completing the workflow above, output ONLY the final refined drama.
          - NO thinking tags in output
          - NO fancy formatting (bold, italics, etc.)
          - NO explanations or metadata
          - Just the raw drama, concise and punchy
      - name: =reasoning
        value: '={{ {effort: "minimal"} }}'
    options: {}
  type: n8n-nodes-base.httpRequest
  typeVersion: 4.2
  position:
  - 608
  - -128
  id: cb55a8de-badb-4175-92f4-894e8ed53b89
  name: Drama+AI
  alwaysOutputData: false
  credentials:
    openRouterApi:
      id: e4D9LdgWoEY0nlVy
      name: OpenRouter account
- parameters:
    mode: runOnceForEachItem
    jsCode: |-
      const FormData = require('form-data');
      const axios = require('axios');

      const content = `
      > ${$('Generate Style').item.json.dramaStyle}

      ## Reasoning
      ---
      ${$input.item.json.output[0].content[0].text}

      ## Output
      ---
      ${$input.item.json.output[1].content[0].text}

      ## Metrics
      |               | Value |
      |---------------|-------|
      | **Input**     | ${$input.item.json.usage.input_tokens} tokens |
      | **Reasoning** | ${$input.item.json.usage.output_tokens_details.reasoning_tokens} tokens |
      | **Output**    | ${$input.item.json.usage.output_tokens - $input.item.json.usage.output_tokens_details.reasoning_tokens} tokens |
      | **Damage**    | $${$input.item.json.usage.cost || 0} |
      `;

      const formData = new FormData();
      formData.append('content', content);
      formData.append('expiration', 'never');
      formData.append('syntax_highlight', 'none');
      formData.append('privacy', 'readonly');
      formData.append('uploader_password', 'YOUR_UPLOADER_PASSWORD');
      formData.append('plain_key', 'YOUR_UPLOADER_PASSWORD');
      formData.append('file', '');
      formData.append('random_key', '');

      const response = await axios.post('https://bin.oksh.re/upload', formData, {
        headers: formData.getHeaders(),
        maxRedirects: 0,
        validateStatus: () => true
      });

      return {
        json: {
          ...$input.item.json,
          reasoning_url: `${response.headers.location}.md#ai` // Custom renderer
        }
      };
  id: e91fc725-d3c2-43ee-bba2-f978fa8c7b7c
  name: Upload Reasoning
  type: n8n-nodes-base.code
  typeVersion: 2
  position:
  - 800
  - -128
connections:
  Start:
    main:
    - - node: No Operation, do nothing
        type: main
        index: 0
  Cron:
    main:
    - - node: No Operation, do nothing
        type: main
        index: 0
  Fetch elements.json:
    main:
    - - node: Fetch sentences.json
        type: main
        index: 0
  Fetch sentences.json:
    main:
    - - node: Generate Drama
        type: main
        index: 0
  Generate Drama:
    main:
    - - node: Merge Shared
        type: main
        index: 1
  Extract AI Drama:
    main:
    - - node: Dispatch Drama
        type: main
        index: 0
  Generate Style:
    main:
    - - node: Merge Shared
        type: main
        index: 2
  No Operation, do nothing:
    main:
    - - node: Fetch elements.json
        type: main
        index: 0
      - node: Fetch styles.json
        type: main
        index: 0
      - node: Channel Config
        type: main
        index: 0
  Fetch styles.json:
    main:
    - - node: Generate Style
        type: main
        index: 0
  Channel Config:
    main:
    - - node: Split Out Channels
        type: main
        index: 0
      - node: Seed Channels
        type: main
        index: 0
  Format Messages:
    main:
    - - node: Merge Shared
        type: main
        index: 0
  Get Messages:
    main:
    - - node: Format Messages
        type: main
        index: 0
  Merge Shared:
    main:
    - - node: Seed Channels
        type: main
        index: 1
  Seed Channels:
    main:
    - - node: Drama+AI
        type: main
        index: 0
  Split Out Channels:
    main:
    - - node: Get Messages
        type: main
        index: 0
  Dispatch Drama:
    main:
    - - node: React with ðŸ”¥
        type: main
        index: 0
      - node: React with ðŸ¥¶
        type: main
        index: 0
  Drama+AI:
    main:
    - - node: Upload Reasoning
        type: main
        index: 0
  Upload Reasoning:
    main:
    - - node: Extract AI Drama
        type: main
        index: 0
pinData: {}
meta:
  templateCredsSetupCompleted: true
  instanceId: 772de366ee37d38fecf1632867a4a1a33b48224bf1f5e46d10b281fe6aeb4c19
